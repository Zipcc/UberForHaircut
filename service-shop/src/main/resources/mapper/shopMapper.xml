<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bristol.project.dao.ShopDao">

    <insert id="create" parameterType="Shop" useGeneratedKeys="true">
        <selectKey resultType="java.lang.Long" order="AFTER" keyProperty="shopId">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into shop(username, shop_name, location_description,
                         service_for_gender, phone_number)
        values(#{username},#{shopName},#{locationDescription},
               #{serviceForGender},#{phoneNumber});
    </insert>


    <delete id="deleteShopByUsername">
        delete from shop
        where username=#{username} and length(username)=length(#{username});
    </delete>


    <update id="updateShopByUsername" parameterType="Shop">
        update shop, shop_service
        set shop_name=#{shopName},location_description=#{locationDescription},
            service_for_gender=#{serviceForGender},service_name=#{serviceName},
            description=#{description}
        where shop.id=shop_service.shop_id and username=#{username};
    </update>


    <select id="getShopByShopName" resultType="Shop">
        select * from shop
        where shop_name=#{shopName} and length(shop_name)=length(#{shopName});
    </select>


    <select id="getShopByUsername" resultMap="shopWithService">
        select * from shop
        where username=#{username} and length(username)=length(#{username});
    </select>
    <resultMap id="shopWithService" type="Shop" >
        <collection property="shopServices" javaType="ArrayList" ofType="ShopService" select="getShopServiceByShopId" column="Shop_id"/>
    </resultMap>
    <select id="getShopServiceByShopId" resultType="ShopService">
        select * from shop_service
        where shop_id = #{id}
    </select>


    <select id="getSomeShop" resultMap="shopWithService">
        select * from shop order by `rate_points` DESC limit 10;
    </select>


    <select id="getAllShop" resultMap="shopWithService">
        select * from shop;
    </select>

</mapper>